<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Th·ªëng k√™ - Kho ph·ª• t√πng</title>

    <!-- Th∆∞ vi·ªán -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
      rel="stylesheet"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>
  <script>
    /* ===== ƒê·ªìng b·ªô giao di·ªán t·ª´ localStorage ===== */
    (function applyDashboardTheme() {
      const logo = localStorage.getItem("sidebarLogo");
      const color = localStorage.getItem("themeColor") || "#1e88e5";

      // √Åp d·ª•ng logo n·∫øu c√≥
      const logoImg = document.getElementById("sidebarLogo");
      if (logo && logoImg) {
        logoImg.src = logo;
      }

      // √Åp d·ª•ng m√†u theme (√°p d·ª•ng cho t·∫•t c·∫£ ph·∫ßn t·ª≠ s·ª≠ d·ª•ng --primary)
      document.documentElement.style.setProperty("--primary", color);
    })();
  </script>
  <nav class="mobile-bottom-nav d-lg-none">
    <a href="./index.html"
      ><i class="bi bi-speedometer2"></i><span>Dashboard</span></a
    >
    <a href="./home.html"><i class="bi bi-box"></i><span>Kho</span></a>
    <a href="./stats.html"
      ><i class="bi bi-bar-chart"></i><span>Th·ªëng k√™</span></a
    >
    <a href="./payment.html"
      ><i class="bi bi-cash-coin"></i><span>Thanh to√°n</span></a
    >
    <a href="./settings.html"><i class="bi bi-gear"></i><span>C√†i ƒë·∫∑t</span></a>
  </nav>
  <!-- MODAL HI·ªÇN TH·ªä CHI TI·∫æT H√ìA ƒê∆†N -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi ti·∫øt h√≥a ƒë∆°n</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>

        <div class="modal-body">
          <div id="orderDetailContent">
            <!-- JS load v√†o -->
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  </div>

  <body>
    <!-- Trong .dashboard-header -->

    <!-- ... -->

    <!-- Overlay ƒë·ªÉ click ra ngo√†i l√† ƒë√≥ng -->
    <div id="sidebarOverlay" class="sidebar-overlay d-lg-none"></div>

    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <div class="sidebar-header d-flex align-items-center mb-4">
        <div class="sidebar-logo">
          <img
            id="sidebarLogo"
            src="https://cdn-icons-png.flaticon.com/512/679/679922.png"
            alt="Logo"
          />
        </div>
        <h3 class="sidebar-title m-0 ms-2">Kho ph·ª• t√πng</h3>
      </div>
      <ul>
        <li>
          <a href="index.html"><i class="bi bi-speedometer2"></i> Dashboard</a>
        </li>
        <li>
          <a href="home.html"><i class="bi bi-box"></i> Qu·∫£n l√Ω kho</a>
        </li>
        <li>
          <a href="stats.html" class="active"
            ><i class="bi bi-bar-chart"></i> Th·ªëng k√™</a
          >
        </li>
        <li>
          <a href="payment.html"><i class="bi bi-cash-coin"></i> Thanh to√°n</a>
        </li>
        <li>
          <a href="settings.html"><i class="bi bi-gear"></i> C√†i ƒë·∫∑t</a>
        </li>
      </ul>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="main">
      <div class="dashboard-header mb-4">
        <h2><i class="bi bi-bar-chart me-2"></i> Th·ªëng k√™ ho·∫°t ƒë·ªông</h2>
        <div class="text-muted small">C·∫≠p nh·∫≠t: th√°ng 10/2025</div>
      </div>

      <div class="row g-4">
        <!-- Bi·ªÉu ƒë·ªì 1 -->
        <div class="col-md-6">
          <div class="chart-card animate__animated animate__fadeInUp">
            <h5><i class="bi bi-graph-up me-2"></i> T·ªìn kho theo h√£ng</h5>
            <canvas id="stockChart" height="200"></canvas>
          </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì 2 -->
        <div class="col-md-6">
          <div
            class="chart-card animate__animated animate__fadeInUp animate__delay-1s"
          >
            <h5><i class="bi bi-pie-chart me-2"></i> T·ª∑ l·ªá lo·∫°i ph·ª• t√πng</h5>
            <canvas id="categoryChart" height="200"></canvas>
          </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì 3 -->
        <div class="col-md-12">
          <div
            class="chart-card animate__animated animate__fadeInUp animate__delay-2s"
          >
            <div class="mt-4">
              <h5>
                <i class="bi bi-receipt-cutoff me-2"></i>Danh s√°ch ƒë∆°n h√†ng
              </h5>

              <div class="table-responsive mt-3">
                <table
                  class="table table-bordered table-hover align-middle table-orders"
                >
                  <thead>
                    <tr>
                      <th>M√£ h√≥a ƒë∆°n</th>
                      <th>T√™n kh√°ch</th>
                      <th>SƒêT</th>
                      <th>T·ªïng ti·ªÅn</th>
                      <th>Ng√†y t·∫°o</th>
                      <th style="width: 120px">Chi ti·∫øt</th>
                    </tr>
                  </thead>

                  <tbody id="orderTableBody">
                    <!-- JS load -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const API_ORDER = "https://motorparts-api.onrender.com/api/orders"; // API th·∫≠t c·ªßa em

      // üëâ 1. Load danh s√°ch ƒë∆°n h√†ng v√†o b·∫£ng
      async function loadOrders() {
        try {
          const res = await fetch(API_ORDER);
          const orders = await res.json();

          const tbody = document.getElementById("orderTableBody");
          tbody.innerHTML = "";

          orders.forEach((order) => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
          <td>${order.orderCode}</td>
          <td>${order.customerName}</td>
          <td>${order.phone}</td>
          <td>${order.total.toLocaleString("vi-VN")} ‚Ç´</td>
          <td>${new Date(order.createdAt).toLocaleString("vi-VN")}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="viewDetail('${
              order._id
            }')">
              <i class="bi bi-eye"></i> Xem
            </button>
          </td>
        `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("L·ªói load orders:", err);
        }
      }

      // üëâ 2. H√†m xem chi ti·∫øt ƒë∆°n h√†ng
      async function viewDetail(id) {
        try {
          const res = await fetch(`${API_ORDER}/${id}`);
          const order = await res.json();

          const html = `
        <h5>M√£ h√≥a ƒë∆°n: ${order.orderCode}</h5>
        <p><strong>Kh√°ch h√†ng:</strong> ${order.customerName}</p>
        <p><strong>SƒêT:</strong> ${order.phone}</p>
        <p><strong>Ng√†y t·∫°o:</strong> ${new Date(
          order.createdAt
        ).toLocaleString("vi-VN")}</p>

        <h6 class="mt-3">Danh s√°ch s·∫£n ph·∫©m</h6>
        <table class="table table-bordered">
          <tr>
            <th>T√™n SP</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Gi√°</th>
            <th>Th√†nh ti·ªÅn</th>
          </tr>
          ${order.items
            .map(
              (item) => `
            <tr>
              <td>${item.name}</td>
              <td>${item.quantity}</td>
              <td>${item.price.toLocaleString("vi-VN")} ‚Ç´</td>
              <td>${(item.price * item.quantity).toLocaleString("vi-VN")} ‚Ç´</td>
            </tr>`
            )
            .join("")}
        </table>

        <h5 class="text-end text-primary">
          T·ªïng c·ªông: ${order.total.toLocaleString("vi-VN")} ‚Ç´
        </h5>
      `;

          document.getElementById("orderDetailContent").innerHTML = html;

          // M·ªü modal
          const modal = new bootstrap.Modal(
            document.getElementById("orderDetailModal")
          );
          modal.show();
        } catch (error) {
          console.error("L·ªói xem chi ti·∫øt:", error);
        }
      }

      // üëâ Load khi v√†o trang
      loadOrders();
    </script>

    <script src="../js/stats.js"></script>

    <script>
      /* ====== Bi·ªÉu ƒë·ªì 1: T·ªìn kho theo h√£ng ====== */
      const ctxStock = document.getElementById("stockChart");
      new Chart(ctxStock, {
        type: "bar",
        data: {
          labels: ["Honda", "Yamaha", "SYM"],
          datasets: [
            {
              label: "S·ªë l∆∞·ª£ng t·ªìn kho",
              data: [120, 90, 45],
              backgroundColor: ["#1E88E5", "#43A047", "#FBC02D"],
              borderRadius: 8,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } },
        },
      });

      /* ====== Bi·ªÉu ƒë·ªì 2: T·ª∑ l·ªá lo·∫°i ph·ª• t√πng ====== */
      const ctxCategory = document.getElementById("categoryChart");
      new Chart(ctxCategory, {
        type: "doughnut",
        data: {
          labels: ["ƒê√®n", "Phanh", "Phu·ªôc", "Nh√¥ng s√™n dƒ©a", "L·ªçc gi√≥"],
          datasets: [
            {
              data: [25, 15, 20, 30, 10],
              backgroundColor: [
                "#1E88E5",
                "#43A047",
                "#FBC02D",
                "#8E24AA",
                "#F4511E",
              ],
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
              labels: { usePointStyle: true, font: { size: 13 } },
            },
          },
        },
      });
      async function loadRevenueChart() {
        try {
          const res = await fetch(
            "https://motorparts-api.onrender.com/api/stats/revenue-monthly"
          );
          const data = await res.json();

          const ctxRevenue = document.getElementById("revenueChart");

          new Chart(ctxRevenue, {
            type: "line",
            data: {
              labels: data.months, // ["Th1", "Th2", ...]
              datasets: [
                {
                  label: "Doanh thu (‚Ç´)",
                  data: data.revenue, // M·∫£ng doanh thu API tr·∫£ v·ªÅ
                  borderColor: "#1E88E5",
                  backgroundColor: "rgba(25,118,210,0.15)",
                  fill: true,
                  tension: 0.35,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointBackgroundColor: "#1565C0",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return value.toLocaleString("vi-VN") + " ‚Ç´";
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("L·ªói t·∫£i doanh thu:", error);
        }
      }

      // G·ªçi API khi load trang
      loadRevenueChart();
    </script>
  </body>
</html>
